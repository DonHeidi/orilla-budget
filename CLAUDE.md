# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Orilla Budget is a time tracking and budget management application built with TanStack Start (React), Bun, Drizzle ORM, and SQLite. The app provides both an admin interface for managing organisations, projects, and time entries, as well as a client portal for viewing budget information.

**Note**: The admin interface uses the `/dashboard` route (not `/admin`). All administrative pages are under `/dashboard/*`.

## Commands

### Development
```bash
bun install          # Install dependencies
bun run dev          # Start development server (runs on port 3000)
bun run build        # Build for production
```

### Database Management
```bash
bun run db:generate  # Generate migration files from schema changes
bun run db:migrate   # Run migrations
bun run db:push      # Push schema changes directly to database (dev only)
bun run db:studio    # Open Drizzle Studio for database visualization
```

## Git Workflow

### Commit Convention
This project follows **Conventional Commits** with the **Angular preset**.

**Note**: Keep commit messages concise. Do not include Claude Code attribution footers or Co-Authored-By tags.

#### Format
```
<type>(<scope>): <subject>

<body>
```

#### Types
- **feat**: A new feature
- **fix**: A bug fix
- **docs**: Documentation only changes
- **style**: Changes that do not affect the meaning of the code (formatting, whitespace, etc.)
- **refactor**: A code change that neither fixes a bug nor adds a feature
- **perf**: A code change that improves performance
- **test**: Adding missing tests or correcting existing tests
- **chore**: Changes to the build process or auxiliary tools

#### Examples
```bash
# Bug fix
fix(theme): prevent flash of unstyled content on page load

# New feature
feat(dashboard): add bulk delete for time entries

# Performance improvement
perf(db): add index on project queries
```

## Architecture

### Tech Stack
- **Runtime**: Bun
- **Framework**: TanStack Start (React-based full-stack framework)
- **Routing**: TanStack Router with file-based routing
- **Database**: SQLite with Drizzle ORM
- **Validation**: Zod schemas
- **Forms**: TanStack Form with Zod adapter
- **Styling**: Tailwind CSS 4.0 with Radix UI components
- **UI Components**: Custom components in `src/components/ui/` based on shadcn/ui

### Project Structure

#### Database Layer (`src/db/`)
- `schema.ts`: Drizzle schema definitions for organisations, accounts, projects, and time entries
- `index.ts`: Database connection using Bun SQLite driver
- Database file: `data.db` at project root

#### Server Layer (`src/server/repositories/`)
Repository pattern for data access:
- `organisation.repository.ts`: Organisation CRUD operations
- `account.repository.ts`: Account management including access code lookup
- `project.repository.ts`: Project management
- `timeEntry.repository.ts`: Time entry tracking

#### Routes (`src/routes/`)
File-based routing with TanStack Start:
- `__root.tsx`: Root layout with theme provider and HTML structure
- `index.tsx`: Landing/home page
- `dashboard.tsx`: Full admin interface with sidebar navigation for managing all entities
- `portal.tsx`: Client portal with access code authentication

#### Types and Schemas
- `src/types.ts`: TypeScript interfaces for domain models and view models
- `src/schemas.ts`: Zod validation schemas for all entities, including special `quickTimeEntrySchema` for rapid data entry

### Key Concepts

#### Server Functions
Routes use `createServerFn()` from TanStack Start to define server-side logic that can be called from client components. These functions handle database operations via repositories.

#### Repository Pattern
All database access goes through repository modules that encapsulate Drizzle ORM queries. Repositories provide standard CRUD operations and domain-specific queries.

#### Dual Interface Architecture
- **Dashboard (`/dashboard`)**: Full CRUD interface with sidebar navigation organized by organisations, projects, and accounts
- **Portal (`/portal`)**: Read-only client view authenticated via access codes

#### Theme System
- Theme preference stored in cookies (`orilla-ui-theme`)
- Server-side theme detection in `__root.tsx` to prevent flash of unstyled content
- Supports dark/light/system modes via `ThemeProvider`

#### Time Entry Flexibility
The app supports both:
- Quick time entries (only title and hours required) via `quickTimeEntrySchema`
- Detailed time entries with project associations and descriptions via `createTimeEntrySchema`

Time entries can be associated with either a project or directly with an organisation.

### Path Aliases
TypeScript is configured with `@/*` path alias mapping to `./src/*` (see `tsconfig.json`).

### Code Generation
- `src/routeTree.gen.ts`: Auto-generated by TanStack Router, do not edit manually
